#!/bin/sh
#
# .ssh_agent_init - POSIX-compliant SSH agent loader
#
# This script ensures a single ssh-agent is running per session,
# and creates environment files for both POSIX (sh, zsh, bash)
# and Fish (fish) shells.
#

# --- Environment File Paths ---
# We use hostname to ensure sockets are not shared across different machines
HOST_ID=$(uname -n)
SSH_ENV_POSIX="$HOME/.ssh/agent-info-$HOST_ID.posix"
SSH_ENV_FISH="$HOME/.ssh/agent-info-$HOST_ID.fish"

# --- Start Agent Function ---
start_agent() {
	echo "Initializing new SSH agent..."
	
	# Create POSIX (sh/bash/zsh) agent file
	/usr/bin/ssh-agent -s | sed 's/^echo/#echo/' > "${SSH_ENV_POSIX}"
	
	# FIX 1: Use 'set -gx' for proper exporting from Fish
	/usr/bin/ssh-agent -c | sed 's/^setenv /set -gx /' | sed 's/^echo/#echo/' > "${SSH_ENV_FISH}"
	
	# Set permissions
	chmod 600 "${SSH_ENV_POSIX}"
	chmod 600 "${SSH_ENV_FISH}"

	# Source the POSIX file for the *current* (sh/bash/zsh) shell
	. "${SSH_ENV_POSIX}" > /dev/null
	
	# Keys should be added manually by the user when needed.
}

# --- Main Logic ---

# --- FIX 2: Removed unreliable 'kill -0' check ---
# This check fails in Termux sub-shells (like in 'refresh')
# because the new shell cannot see the agent's process,
# causing a new, empty agent to be incorrectly started.
if [ -f "${SSH_ENV_POSIX}" ]; then
	# Source the existing file
	. "${SSH_ENV_POSIX}" > /dev/null
else
	# No agent file found. Start a new one for the first time.
	start_agent
fi